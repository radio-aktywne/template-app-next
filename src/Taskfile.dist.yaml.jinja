version: "3.43"

tasks:
  template:
    desc: Fetch template updates
    interactive: true
    env:
      GIT_CONFIG_GLOBAL: ""
      GIT_CONFIG_SYSTEM: ""
    cmds:
      - >-
        copier
        update
        --answers-file
        .copier-answers.yaml
        {{ '{{ .CLI_ARGS }}' }}
  flake:
    desc: Update flake.lock
    cmds:
      - >-
        nix
        --accept-flake-config
        --extra-experimental-features
        'nix-command flakes'
        --no-warn-dirty
        flake
        update
        {{ '{{ .CLI_ARGS }}' }}
  fmt:
    desc: Format files
    cmds:
      {%- if docs %}
      - task: install-docs-internal
        vars:
          CLI_ARGS: ""
      {%- endif %}
      - task: install-internal
        vars:
          CLI_ARGS: ""
      - >-
        trunk
        fmt
        {{ '{{ .CLI_ARGS }}' }}
  lint:
    desc: Lint files
    cmds:
      {%- if docs %}
      - task: install-docs-internal
        vars:
          CLI_ARGS: ""
      {%- endif %}
      - task: install-internal
        vars:
          CLI_ARGS: ""
      - >-
        trunk
        check
        {{ '{{ .CLI_ARGS }}' }}
  {%- if docs %}
  install-docs:
    desc: Install docs dependencies
    dir: docs/
    sources:
      - package-lock.json
      - package.json
      - ../flake.lock
      - ../*.nix
      - ../Taskfile.dist.yaml
      - ../{taskfile,Taskfile}.{yaml,yml}
    generates:
      - node_modules/**/*
    cmds:
      - >-
        npm
        install
        {{ '{{ .CLI_ARGS }}' }}
  install-docs-internal:
    desc: Install docs dependencies quietly
    internal: true
    dir: docs/
    cmds:
      - task: install-docs
        vars:
          CLI_ARGS: >-
            --prefer-offline
            --no-audit
            --no-fund
            --quiet
            --no-progress
  update-docs:
    desc: Update docs package-lock.json
    dir: docs/
    cmds:
      - >-
        npm
        update
        {{ '{{ .CLI_ARGS }}' }}
  docs:
    desc: Run docusaurus
    dir: docs/
    interactive: true
    cmds:
      - task: install-docs-internal
        vars:
          CLI_ARGS: ""
      - >-
        npm
        exec
        --
        docusaurus
        {{ '{{ .CLI_ARGS | default "start --host 0.0.0.0" }}' }}
  {%- endif %}
  install:
    desc: Install dependencies
    sources:
      - flake.lock
      - "*.nix"
      - package-lock.json
      - package.json
      - Taskfile.dist.yaml
      - "{taskfile,Taskfile}.{yaml,yml}"
    generates:
      - node_modules/**/*
    cmds:
      - >-
        npm
        install
        {{ '{{ .CLI_ARGS }}' }}
  install-internal:
    desc: Install dependencies quietly
    internal: true
    cmds:
      - task: install
        vars:
          CLI_ARGS: >-
            --prefer-offline
            --no-audit
            --no-fund
            --quiet
            --no-progress
  update:
    desc: Update package-lock.json
    cmds:
      - >-
        npm
        update
        {{ '{{ .CLI_ARGS }}' }}
  clean:
    desc: Clean build outputs
    cmds:
      - >-
        rm
        --recursive
        --force
        {{ '{{ .CLI_ARGS }}' }}
        build/
    status:
      - >-
        test
        '!'
        -d
        build/
  build:
    desc: Build outputs
    sources:
      - public/**/*
      - src/**/*
      - flake.lock
      - "*.nix"
      - lingui.config.ts
      - next.config.ts
      - package-lock.json
      - package.json
      - postcss.config.mjs
      - Taskfile.dist.yaml
      - "{taskfile,Taskfile}.{yaml,yml}"
      - tsconfig.json
    generates:
      - build/**/*
    cmds:
      - task: install-internal
        vars:
          CLI_ARGS: ""
      - >-
        npm
        exec
        --
        next
        build
        --webpack
        {{ '{{ .CLI_ARGS }}' }}
  build-internal:
    desc: Build outputs quietly
    internal: true
    cmds:
      - task: build
        vars:
          CLI_ARGS: ""
  locales:
    desc: Extract locales
    cmds:
      - task: install-internal
        vars:
          CLI_ARGS: ""
      - >-
        npm
        exec
        --
        lingui
        extract
        --clean
        --overwrite
        {{ '{{ .CLI_ARGS }}' }}
  apis:
    desc: Generate code for APIs
    sources:
      - openapi/**/*
      - flake.lock
      - "*.nix"
      - openapi-ts.config.mts
      - package-lock.json
      - package.json
      - Taskfile.dist.yaml
      - "{taskfile,Taskfile}.{yaml,yml}"
      - tsconfig.json
    generates:
      - src/common/apis/**/*
    cmds:
      - task: install-internal
        vars:
          CLI_ARGS: ""
      - >-
        npm
        exec
        --
        openapi-ts
        {{ '{{ .CLI_ARGS }}' }}
      - task: fmt
        vars:
          CLI_ARGS: src/common/apis
  dev:
    desc: Run in development mode
    interactive: true
    cmds:
      - task: install-internal
        vars:
          CLI_ARGS: ""
      - >-
        npm
        run
        --
        dev
        {{ '{{ .CLI_ARGS }}' }}
  run:
    desc: Run the app
    interactive: true
    cmds:
      - task: install-internal
        vars:
          CLI_ARGS: ""
      - task: build-internal
        vars:
          CLI_ARGS: ""
      - >-
        npm
        run
        --
        run
        {{ '{{ .CLI_ARGS }}' }}
  docker:
    desc: Run in docker container
    interactive: true
    cmds:
      - >-
        docker
        compose
        up
        --build
        --force-recreate
        --remove-orphans
        {{ '{{ .CLI_ARGS }}' }}
